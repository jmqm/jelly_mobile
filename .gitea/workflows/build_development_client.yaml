name: Build development client
on: push
#on:
  #pull_request:
    #types:
      #- closed
    #branches:
      #- main

jobs:
  main:
    runs-on: ubuntu-20.04

    steps:
    - name: üèó Check out repo
      uses: actions/checkout@v3

    - name: ‚úç Update version number
      run: |
        YEAR=$(date +"%Y")
        MONTH=$(date +"%m")
        VERSION="$YEAR.$MONTH.$GITHUB_RUN_NUMBER-dev"
        sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
        sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" app.json
        echo "Changed version to $VERSION in package.json and app.json"

    - name: ‚öô Install Node
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: ‚öô Install Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: 17

    - name: ‚öô Install Android SDK
      uses: android-actions/setup-android@v2

    - name: ‚öô Install Expo and EAS
      uses: expo/expo-github-action@v7
      with:
        token: ${{ secrets.EXPO_TOKEN }}
        expo-version: latest
        eas-version: latest

    - name: ‚öô Install EAS local builds
      run: yarn global add eas-cli-local-build-plugin

    - name: ‚öô Install dependencies
      run: yarn install

    - name: üë∑ Build app
      run: |
        eas build --local \
          --non-interactive \
          --output="build/app-debug.apk" \
          --platform=android \
          --profile=development

    - name: üì¶ Upload binary
      uses: actions/upload-artifact@v3
      with:
        name: Android Development Build
        path: build
        retention-days: 30
