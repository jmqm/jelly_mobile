name: Build development client
on: push
#on:
  #pull_request:
    #types:
      #- closed
    #branches:
      #- main

jobs:
  main:
    runs-on: ubuntu-20.04

    steps:
    - name: ğŸ— Check out repo
      uses: actions/checkout@v3

    - name: âœ Update version number
      run: |
        YEAR=$(date +"%Y")
        MONTH=$(date +"%m")
        VERSION="$YEAR.$MONTH.$GITHUB_RUN_NUMBER-dev"
        sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" package.json
        sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION\"/" app.json
        echo "Changed version to $VERSION in package.json and app.json"

    - name: ğŸ“” Hash files for caching
      uses: seepine/hash-files@v1
      id: get-hash
      with:
        patterns: |
          **/yarn.lock
          **/package-lock.json

    - name: ğŸ“” Cache node modules
      uses: actions/cache@v3
      with:
        path: node_modules
        key: ${{ runner.os }}-node-${{ steps.get-hash.outputs.hash }}
        restore-keys: |
            ${{ runner.OS }}-node-

    - name: âš™ Install Node
      uses: actions/setup-node@v3
      with:
        node-version: 18

    - name: âš™ Install Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: 17

    - name: âš™ Install Android SDK
      uses: android-actions/setup-android@v2

    - name: âš™ Install Expo and EAS
      uses: expo/expo-github-action@v7
      with:
        token: ${{ secrets.EXPO_TOKEN }}
        expo-version: latest
        eas-version: latest

    - name: âš™ Install EAS local builds
      run: yarn global add eas-cli-local-build-plugin

    - name: âš™ Install dependencies
      run: yarn install

    #- name: ğŸ“‹ Test project
    #  run: yarn test

    - name: ğŸ‘· Build app
      run: |
        eas build --local \
          --non-interactive \
          --output="build/app-debug.apk" \
          --platform=android \
          --profile=development

    - name: ğŸ“¦ Upload binary
      uses: actions/upload-artifact@v3
      with:
        name: Android Development Build
        path: build
        retention-days: 30
